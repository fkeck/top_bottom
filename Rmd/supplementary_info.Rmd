---
title: "Supplementary Information for:"
output:
  pdf_document:
    toc_depth: 5
    fig_caption: false
    latex_engine: xelatex
header-includes:
  - \usepackage{leading}
  - \usepackage{setspace}
bibliography: top_bottom_SI.bib
csl: nature-communications.csl
link-citations: true
---

```{r setup, include=FALSE}
include_supp_text <- TRUE
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(magrittr)
load("../data/Supp_mat.Rdata")
fig_num <- 0
tab_num <- 0
ins_tab <- function(){
  .GlobalEnv$tab_num <- .GlobalEnv$tab_num + 1
  cat(paste0("##### Table ", .GlobalEnv$tab_num, "."))
}
ins_fig <- function(){
  .GlobalEnv$fig_num <- .GlobalEnv$fig_num + 1
  cat(paste0("##### Figure ", .GlobalEnv$fig_num, "."))
}

library(tmap)

library(kableExtra)
usepackage_latex("booktabs")
usepackage_latex("longtable")
usepackage_latex("array")
usepackage_latex("multirow")
usepackage_latex("wrapfig")
usepackage_latex("float")
usepackage_latex("colortbl")
usepackage_latex("pdflscape")
usepackage_latex("tabu")
usepackage_latex("threeparttable")
usepackage_latex("threeparttablex")
usepackage_latex("ulem", "normalem")
usepackage_latex("makecell")

```
\leading{20pt}

\begin{huge}  
Assessing the response of micro-eukaryotic diversity to the Great Acceleration: a paleolimnological view based on sedimentary DNA
\end{huge} 


Keck et al.

` `  
` `  

Corresponding author: Isabelle Domaizon (isabelle.domaizon@inrae.fr)

` `  
` `  

\newpage
\renewcommand{\contentsname}{Supplementary Information}
\setcounter{tocdepth}{5}
\tableofcontents

<!-- **This PDF file includes:** -->

<!-- - Methods S1 to S5 -->
<!-- - Figures S1 to S6 -->
<!-- - Tables S1 to S3 -->
<!-- - Legend for Dataset S1 -->
<!-- - SI References -->

<!-- **Other supplementary materials for this manuscript include the following:** -->

<!-- Dataset S1 -->

\pagebreak

```{r child = "supp_text.Rmd", eval = include_supp_text}
```

\singlespacing

<!-- \pagebreak -->
<!-- ```{r, message = FALSE} -->
<!-- lakes_tab %>%  -->
<!--   ggplot(aes(x = Altitude, fill = `Trophic status`)) + -->
<!--     geom_histogram(position = 'stack', binwidth = 500) + -->
<!--     scale_fill_manual(values = c("Eutrophic" = "#006D2C", -->
<!--                                  "Meso-eutrophic" = "#2CA25F", -->
<!--                                  "Mesotrophic" = "#66C2A4", -->
<!--                                  "Oligo-mesotrophic" = "#99D8C9", -->
<!--                                  "Oligotrophic" = "#CCECE6", -->
<!--                                  "Unknown" = "grey70")) + -->
<!--   labs(fill = "Trophic status") + xlab("Altitude (m)") + ylab("Count") + -->
<!--   theme_bw() -->


<!-- ``` -->


<!-- SKIPED NUM Distribution of lake elevation and trophic status. -->


\pagebreak
\addcontentsline{toc}{subsection}{Supplementary Figures}

```{r Map, fig.height=8}

data(countriesLow, package = "rworldmap")
eu_shp <- countriesLow[!is.na(countriesLow$REGION), ]
eu_shp <- eu_shp[eu_shp$REGION == "Europe", ]

lakes_tab <- read_csv("../data/lakes_coring.csv", na = character())
lakes_coords <- read_csv("../data/lakes_coords.csv")
lakes_coords <- left_join(lakes_coords, lakes_tab, by = c("LAC" = "Name")) %>%
  select(Code, LAC, X, Y) %>%
  sp::SpatialPointsDataFrame(.[, c("X", "Y")], .,
                             proj4string = sp::CRS("+init=epsg:4326"))

lakes_coords <- lakes_coords[lakes_coords$LAC %in% otu_merge_tbl$LAC, ]

tm_shape(eu_shp, bbox = sf::st_bbox(c(xmin = -5, xmax = 10, ymax = 52, ymin = 41))) +
  tm_fill(col = "grey80") +
  tm_borders(col = "grey60") +
  tm_scale_bar(breaks = c(0, 100, 200), text.size = 0.7, position = c(0.6, 0.02)) +
  tm_layout(bg.color = "lightblue") +
  tm_graticules(lines = FALSE) +
  tm_shape(lakes_coords) +
  tm_dots(size = 0.01, shape = 20, col = "red") +
  tm_text(text = "Code", auto.placement = T, size = 0.4)


```

```{r, results="asis"}
ins_fig()
```
Map of the 48 lakes included in the study. Lake names corresponding to three-letter codes can be found in Supplementary Table 1.



\pagebreak

![](../figures/supplementary_info/SI_FIG_bioinfo.pdf)

```{r, results="asis"}
ins_fig()
```
Tracking of the number of DNA reads and OTUs during the filtering and data pre-processing steps. Numbers written in small print indicate the mean values per sample (or merged sample after merging). 


\pagebreak
```{r TB relative richness, fig.height = 8}
tax_rich_dat <-
  com_merged_raw_list %>% 
  filter(INVENTORY == "OTU") %>% 
  .$data %>% .[[1]] %>%
  spread_cdm(LAC_POS, TAXON, COUNT) %>% 
  rrarefy(sample = min(rowSums(.))) %>% 
  tidy_cdm(row.name = "LAC_POS") %>% 
  left_join(lakes_meta_nr)

tax_rich_lakes <- tax_rich_dat %>% 
  group_by(LAC, POSITION) %>% 
  summarise(RICH_LAKE = sum(COUNT > 0))

p <- tax_rich_dat %>% 
  left_join(otu_meta, by = c("TAXON" = "OTU_ID")) %>% 
  group_by(ADL_RANK_2, POSITION) %>% 
  nest() %>% 
  mutate(RICH = map(data, function(data){
    data %>% 
      spread_cdm(LAC, TAXON, COUNT) %>% 
      specnumber() %>% 
      enframe("LAC", "RICHNESS")
  })) %>% 
  unnest(RICH) %>% 
  left_join(tax_rich_lakes) %>% 
  mutate(REL_RICHNESS = RICHNESS/RICH_LAKE) %>% 
  group_by(ADL_RANK_2, POSITION) %>% 
  summarise(REL_RICHNESS_MEAN = mean(REL_RICHNESS),
            REL_RICHNESS_SD = sd(REL_RICHNESS)) %>% 
  left_join(read_csv("../data/ranks_Adl.csv"), by = c("ADL_RANK_2" = "RANK2")) %>% 
  group_by(RANK1) %>% 
  mutate(GRP2_REL_RICHNESS_SUM = sum(REL_RICHNESS_MEAN, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(ADL_RANK_2 = fct_explicit_na(ADL_RANK_2, "Unclassified"),
         RANK1 = fct_explicit_na(RANK1, "Unclassified")) %>% 
  ggplot() +
  geom_col(aes(fct_reorder(ADL_RANK_2, REL_RICHNESS_MEAN),
               REL_RICHNESS_MEAN, fill = POSITION),
           position = "dodge2") +
  facet_wrap(~ fct_reorder(RANK1, GRP2_REL_RICHNESS_SUM, .desc = TRUE),
             scales = "free_y", ncol = 1, strip.position = "left") +
  geom_linerange(aes(x = fct_reorder(ADL_RANK_2, REL_RICHNESS_MEAN),
                         ymin = REL_RICHNESS_MEAN + REL_RICHNESS_SD,
                         ymax = REL_RICHNESS_MEAN - REL_RICHNESS_SD),
           position = position_dodge2(width = 1, padding = 0.5)) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_discrete(name = "Stratum", labels = c("Past (bottom)", "Recent (top)")) +
  xlab("") + ylab("Relative richness") +
  theme(strip.text.y = element_text(angle = 180),
        strip.placement = "outside")

gp <- ggplotGrob(p)
f_row <- gp$layout$t[grepl("panel", gp$layout$name)]
x_var <- sapply(ggplot_build(p)$layout$panel_scales_x,
                function(l) length(l$range$range))
gp$heights[f_row] <- gp$heights[f_row] * x_var
grid::grid.draw(gp)
```

```{r, results="asis"}
ins_fig()
```
Mean relative richness (number of distinct OTUs) for each taxa computed for the bottom and the top rarefied samples across all lakes. Horizontal black lines show the standard error.




<!-- \pagebreak -->
<!-- ```{r, fig.height = 7} -->

<!-- prow <- plot_grid(frac_taxa_temp$plots[[1]] + -->
<!--             theme(legend.position = "none"), -->
<!--           frac_taxa_temp$plots[[2]] + -->
<!--             theme(legend.position = "none") + -->
<!--             xlab(""), -->
<!--           labels = "AUTO") -->
<!-- legend <- get_legend( -->
<!--   frac_taxa_temp$plots[[1]] + -->
<!--     guides(color = guide_legend(nrow = 1)) + -->
<!--     theme(legend.position = "bottom", -->
<!--           legend.title = element_blank()) -->
<!-- ) -->
<!-- plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1)) -->
<!-- ``` -->

<!-- ****  Proportion of OTUs (*A*) and 3^rd^ rank taxonomic groups (*B*) specific to the bottom and top strata, or common to both strata (intersection). The total number of OTUs or taxa is given for each lake in parenthesis. -->


\pagebreak

![](../figures/supplementary_info/SI_FIG_venn.pdf)

```{r Venn diagram, results="asis"}
ins_fig()
```
Venn diagram showing the number and proportion of OTUs specific to the bottom and top strata, or common to both strata (intersection).


\pagebreak
```{r NMDS OTU Jaccard, fig.height = 6}

SUPP_MAT$JACC$FIG_COMB

```

```{r, results="asis"}
ins_fig()
```
Community analyses of the OTUs table reproduced with the Jaccard dissimilarity index. (*A*) NMDS of community compositions of the ‘recent’ (blue triangles) and ‘past’ (red circles) samples with 95% confidence ellipses represented for each group. Grey lines connect ‘recent’ and ‘past’ samples from the same lake. Stress = 0.24. (*B*) Distribution of Jaccard index values computed for each lake between ‘recent’ and ‘past’ samples. (*C*) Distribution of the distances between samples and group geometric median for ‘recent’ (blue) and ‘past’ (red) samples. (*D*) Relationship between lake altitude and community dissimilarity (Jaccard index) between the ‘recent’ and ‘past’ strata. Fitted regression tree model is represented by black lines (mean values). Grey shading represents the 95% confidence intervals around means.


\pagebreak
```{r NMDS Taxo2 Bray, fig.height = 6}

SUPP_MAT$TAXO$FIG_COMB

```

```{r, results="asis"}
ins_fig()
```
Community analyses reproduced with the data aggregated at the 2^nd^ taxonomic rank of Adl et al [@adl_revisions_2019]. (*A*) NMDS of community compositions of the ‘recent’ (blue triangles) and ‘past’ (red circles) samples with 95% confidence ellipses represented for each group. Grey lines connect ‘recent’ and ‘past’ samples taken within the same lake. Stress = 0.19.  (*B*) Distribution of Bray-Curtis index values computed for each lake between ‘recent’ and ‘past’ samples. (*C*) Distribution of the distances between samples and group geometric median for ‘recent’ (blue) and ‘past’ (red) samples. (*D*) Relationship between lake altitude and community dissimilarity (Bray-Curtis index) between the ‘recent’ and ‘past’ strata. Fitted regression tree model is represented by black lines (mean values). Grey shading represents the 95% confidence intervals around means.

\pagebreak
```{r DESeq2 barplot Taxo3, fig.height = 8}
deseq_TB_AOV1 %>%
  filter(INVENTORY == "Taxonomie Rank 3") %>%
  .$barplots %>% .[[1]] +
  theme(plot.title = element_blank())
```

```{r, results="asis"}
ins_fig()
```
Magnitude of change (expressed in log2 fold change) in data aggregated at the 3^rd^ taxonomy rank of Adl et al [@adl_revisions_2019] between the past and recent strata, as estimated by the DESeq2 analysis [@adl_revisions_2019]. Dark bars represent groups for which the change was found significant (corrected p-value < 0.05). Horizontal lines show the standard error. The detailed results of the analysis are given in Supplementary Table 3.


\pagebreak

```{r Human footprint altitude, fig.height = 6.5}
lakes_lc <- read_csv("../data/synthese_landcover.csv")
lakes_pop <- read_csv("../data/synthese_pop.csv")
source("../R/AN_landcover.R")
print(lc_plots)
```

```{r, results="asis"}
ins_fig()
```
Proportion of (*A*) natural, (*B*) agricultural and (*C*) artificial surfaces in watersheds of high- ($> 1400$ m) and low-altitude ($\leq 1400$ m) lakes. The landcover analysis was conducted on a subset of 39 lakes for which data were available (10 high altitude lakes and 29 low altitude lakes). (*D*) Total human population living within a radius of 20 km of high-altitude lakes (N = 17) and low-altitude lakes (N = 31).



\pagebreak
```{r Replicate hclust, fig.height = 8}
t <- otu_tbl_replicates %>% 
  filter(!LAC %in% c("Léman", "Bourget")) %>% 
  mutate(ID_SAMPLE = str_c(LAC_CODE, POSITION, REPLICATE, sep = "_")) %>% 
  spread_cdm(ID_SAMPLE, OTU_ID, OTU_COUNT) %>% 
  vegdist(method = "bray") %>% 
  hclust() %>% 
  ape::as.phylo.hclust()
t2 <- phytools::splitTree(t, list(node = 188, bp = 0))
par(mfrow = c(1, 2))
ape::plot.phylo(ape::drop.tip(t, t2[[1]]$tip.label), cex = 0.5, no.margin = TRUE)
ape::plot.phylo(ape::drop.tip(t, t2[[2]]$tip.label), cex = 0.5, no.margin = TRUE)
par(mfrow = c(1, 1))
```

```{r, results="asis"}
ins_fig()
```
Hierarchical clustering of the OTU matrix (Bray Curtis dissimilarity) including the technical replicates. The code of each sample corresponds to the combination of the lake (three-letter code; see Supplementary Table 1), stratum (top or bottom) and replicate number (1 or 2). Lakes Bourget and Léman are not represented as they have only one replicate. For better readability, the tree has been divided in two parts.



<!-- TABLE SECTION STARTS HERE -->

\pagebreak
\addcontentsline{toc}{subsection}{Supplementary Tables}
```{r Table Lakes, message = FALSE}


lakes_tab <- read_csv("../data/lakes_coring.csv", na = character()) %>% 
  set_names(c("Code", "Name", "Longitude", "Latitude", "Altitude", "Depth (max)",
              "Trophic status", "included_DNA")) %>% 
  arrange(included_DNA, Altitude)

not_included_min <- min(which(lakes_tab$included_DNA == 2))
not_included_max <- max(which(lakes_tab$included_DNA == 2))

lakes_tab <- select(lakes_tab, -included_DNA)
lakes_tab$Name[lakes_tab$Name == "Valcère"] <- "Balcère"

kableExtra::kable(lakes_tab, "latex", digits = 3, booktabs = TRUE, linesep = "", escape = FALSE,
                  col.names = linebreak(colnames(lakes_tab), align = "c")) %>% 
  kable_styling(font_size = 7) %>% 
  pack_rows("Not included for DNA analyses", not_included_min, not_included_max, indent = FALSE, latex_gap_space = "0.5em")

rm(not_included_min, not_included_max)

```

```{r, results="asis"}
ins_tab()
```
List of the lakes included in the study with their three-letter code, geographic coordinates (decimal degrees; WGS84), altitude (m) and maximum depth (m). The trophic status, when referenced, is based on 3 parameters used in the Water Framework Directive, i.e. Secchi disk value, phosphorus concentration in the water and chlorophyll *a* concentration in the euphotic zone.


\pagebreak

```{r Table Coring, message = FALSE}
#lakes_coords <- lakes_coords[lakes_coords$LAC %in% otu_merge_tbl$LAC, ]

lakes_datation <- read_csv("../data/lakes_datation.csv", na = character()) %>% 
  unite(Method, `Method Top`, `Method Bottom`, sep = "/") %>% 
  set_names(
    c("Code", "Name", "Coring\nyear", "XrF\ndata", "$^{14}$C", "Radionuclides",
    "1986 $^{137}$Cs\nfallout", "1963 $^{137}$Cs\nfallout",
    "Onset of lead\ndecrease (XrF)", "Increase in\nlead (XrF)",
    "Depth\nTop", "Depth\nBottom", "Method\nTop/Bottom")
  ) %>% 
  mutate(Radionuclides = str_replace(Radionuclides, "137Cs", "$^{137}$Cs"),
         Radionuclides = str_replace(Radionuclides, "210Pb", "$^{210}$Pb")) %>% 
  select(-Code)

  lakes_datation$Name[lakes_datation$Name == "Bourget"] <- paste0("Bourget", footnote_marker_alphabet(1))
  lakes_datation$Name[lakes_datation$Name == "Léman"] <- paste0("Léman", footnote_marker_alphabet(2))
  lakes_datation$Name[lakes_datation$Name == "Gérardmer"] <- paste0("Gérardmer", footnote_marker_alphabet(3))
  lakes_datation$Name[lakes_datation$Name == "Longemer"] <- paste0("Longemer", footnote_marker_alphabet(3))
  lakes_datation$Name[lakes_datation$Name == "Aydat"] <- paste0("Aydat", footnote_marker_alphabet(4))
  lakes_datation$Name[lakes_datation$Name == "Saint-Point"] <- paste0("Saint-Point", footnote_marker_alphabet(5))
  lakes_datation$Name[lakes_datation$Name == "Crégut"] <- paste0("Crégut", footnote_marker_alphabet(6))
  lakes_datation$Name[lakes_datation$Name == "Valcère"] <- "Balcère"

kableExtra::kable(lakes_datation, "latex", digits = 2, booktabs = TRUE, linesep = "",
                  escape = FALSE, align = "llccrrrrrrrc",
                  col.names = linebreak(colnames(lakes_datation), align = "c")) %>% 
  kable_styling(latex_options = c("scale_down"))
```
\footnotesize
\textsuperscript{a}Additional source: Giguet-Covex et al [@giguet-covex_sedimentological_2010] ;  
\textsuperscript{b}Additional source: Alric et al [@alric_local_2013] ;  
\textsuperscript{c}Additional source: Belle et al [@belle_impact_2017] ;  
\textsuperscript{d}Previous studies of Sarazin et al [@sarazin_sedimentation_1992] and Lavrieux et al [@lavrieux_6700_2013] indicated a mean sedimentation rate of 0.46 and 0.52 over the last century. Furthermore, two floods events dated at 1907 and 1846 by Lavrieux et al [@lavrieux_6700_2013] has been identified along the 2015 core from XrF logging at 57.5 and 75.5 cm, respectively.  
\textsuperscript{e}Nedjai et al [@nedjai_multi-secular_2011] indicated a mean sedimentation rate of 0.21 cm/yr over the last century.  
\textsuperscript{f}A strong change in terrigenous elements (e.g. Ti) that occured at 31 cm along the 2015 core corresponds to the year 1970 when the watershed surface was artificially increased from 1.5 to 86 km².\par
\normalsize


```{r, results="asis"}
ins_tab()
```
Data supporting the dating and sampling of sediment cores. For each lakes is reported: the year of coring, the availability of Xrf, ^14^C and radionuclides data, the depth (cm) for 1986 and 1963 ^137^Cs fallouts and lead increase/decrease, the depth (cm) for top and bottom samples. NC stands for "not clear". Methods used to determine the depth of top and bottom samples are indicated in the last column where numbers refer to methods described in Supplementary Methods 2.



\pagebreak

```{r Table Permanova, fig.height = 6}
options(knitr.kable.NA = '')
structure(list(X = c("Top-Bottom", "Residuals", "Total"),
               Degrees.of.freedom = c(1L, 94L, 95L),
               Sums.of.squares = c(2.522, 33.588, 36.109),
               F.stat = c(7.057, NA, NA),
               Partial.R.2. = c(0.070, 0.930, 1),
               P.value = c("<0.001", "", "")),
          class = "data.frame", row.names = c(NA, -3L)) %>% 
  knitr::kable("latex", digits = 3, booktabs = TRUE, linesep = "", escape = FALSE,
               col.names = linebreak(c("", "Degrees of freedom", "Sum of squares",
                                       "F-stat", "Partial R2", "P-value"), align = "c")) %>% 
  kable_styling(position = "center")
options(knitr.kable.NA = NULL)
```

```{r, results="asis"}
ins_tab()
```
Detailed table of the PERMANOVA.


\pagebreak
```{r Table DESeq2 Trophic, fig.height = 6}
deseq_TB_AOV1 %>% 
  filter(INVENTORY == "Trophic Type") %>% .$results %>% .[[1]] %>%
  mutate(Taxa = str_replace(Taxa, "<NA>", "Unclassified (NA)")) %>%
  select(-lfcSE, -pvalue) %>% 
  knitr::kable("latex", digits = 3, booktabs = TRUE, linesep = "", escape = FALSE,
               col.names = linebreak(c("Trophic Group", "Base Mean",
                                       "log2 Fold Change", "Stat", "Padj"), align = "c")) %>% 
  kable_styling(position = "center")
```

```{r, results="asis"}
ins_tab()
```
Detailed results of the DESeq2 analysis conducted on data aggregated by trophic groups. For each group, column *Base Mean* indicates the average of the normalized count values, dividing by size factors, *log2 Fold Change* is the magnitude of change between the past and recent strata, column *Stat* is the Wald statistic and *Padj* the p-value of the test corrected with the Benjamini & Hochberg method.



\pagebreak
```{r Table DESeq2 Taxo3, fig.height = 6}
deseq_TB_AOV1 %>% 
  filter(INVENTORY == "Taxonomie Rank 3") %>% .$results %>% .[[1]] %>%
  left_join(select(otu_taxo_adl_conv, ADL_RANK_1, ADL_RANK_2, ADL_RANK_3), by = c("Taxa" = "ADL_RANK_3")) %>% 
  filter(!duplicated(Taxa)) %>% 
  select(Rank_1 = ADL_RANK_1, Rank_2 = ADL_RANK_2, Rank_3 = Taxa, baseMean, log2FoldChange, stat, padj) %>% 
  arrange(Rank_1, Rank_2, Rank_3) %>% 
  mutate(Rank_1 = ifelse(is.na(Rank_1), "Unclassified", Rank_1),
         Rank_2 = ifelse(is.na(Rank_2), "Unclassified", Rank_2)) %>% 
  mutate(Rank_1 = ifelse(!duplicated(Rank_1), Rank_1, ""),
         Rank_2 = ifelse(!duplicated(Rank_2), Rank_2, "")) %>% 
  knitr::kable("latex", digits = 3, booktabs = TRUE, linesep = "", escape = FALSE, longtable = TRUE,
               col.names = linebreak(c("Rank 1", "Rank 2", "Rank 3", "Base Mean",
                                       "log2 Fold\nChange", "Stat", "Padj"), align = "c")) %>% 
  add_header_above(c("Taxonomic rank (Adl et al. 2019)" = 3, " " = 4)) %>% 
  kable_styling(latex_options =c("repeat_header"))

```

```{r, results="asis"}
ins_tab()
```
Detailed results of the DESeq2 analysis conducted on data aggregated at the 3^rd^ taxonomy rank of Adl et al [@adl_revisions_2019]. Ranks 1 and 2 are given for guidance. For each taxa, column *Base Mean* indicates the average of the normalized count values, dividing by size factors, *log2 Fold Change* is the magnitude of change between the past and recent strata, column *Stat* is the Wald statistic and *Padj* the p-value of the test corrected with the Benjamini & Hochberg method.



\pagebreak

\leading{20pt}

## References
